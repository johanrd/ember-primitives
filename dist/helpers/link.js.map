{"version":3,"file":"link.js","sources":["../../src/helpers/link.ts"],"sourcesContent":["import Helper from '@ember/component/helper';\nimport { assert } from '@ember/debug';\nimport { service } from '@ember/service';\n\nimport { handle } from '../proper-links.ts';\n\nimport type RouterService from '@ember/routing/router-service';\n\nexport interface Signature {\n  Args: {\n    Positional: [href: string];\n    Named: {\n      includeActiveQueryParams?: boolean | string[];\n      activeOnSubPaths?: boolean;\n    };\n  };\n  Return: {\n    isExternal: boolean;\n    isActive: boolean;\n    handleClick: (event: MouseEvent) => void;\n  };\n}\n\nexport default class Link extends Helper<Signature> {\n  @service declare router: RouterService;\n\n  compute(\n    [href]: [href: string],\n    {\n      includeActiveQueryParams = false,\n      activeOnSubPaths = false,\n    }: { includeActiveQueryParams?: boolean | string[]; activeOnSubPaths?: boolean }\n  ) {\n    assert('href was not passed in', href);\n\n    const router = this.router;\n    const handleClick = (event: MouseEvent) => {\n      assert('[BUG]', event.target instanceof HTMLAnchorElement);\n\n      handle(router, event.target, [], event);\n    };\n\n    return {\n      isExternal: isExternal(href),\n      get isActive() {\n        return isActive(router, href, includeActiveQueryParams, activeOnSubPaths);\n      },\n      handleClick,\n    };\n  }\n}\n\nexport const link = Link;\n\nexport function isExternal(href: string) {\n  if (!href) return false;\n  if (href.startsWith('#')) return false;\n  if (href.startsWith('/')) return false;\n\n  return location.origin !== new URL(href).origin;\n}\n\nexport function isActive(\n  router: RouterService,\n  href: string,\n  includeQueryParams?: boolean | string[],\n  activeOnSubPaths?: boolean\n) {\n  if (!includeQueryParams) {\n    /**\n     * is Active doesn't understand `href`, so we have to convert to RouteInfo-esque\n     */\n    let info = router.recognize(href);\n\n    if (info) {\n      let dynamicSegments = getParams(info);\n      let routeName = activeOnSubPaths ? info.name.replace(/\\.index$/, '') : info.name;\n\n      return router.isActive(routeName, ...dynamicSegments);\n    }\n\n    return false;\n  }\n\n  let url = new URL(href, location.origin);\n  let hrefQueryParams = new URLSearchParams(url.searchParams);\n  let hrefPath = url.pathname;\n\n  const currentPath = router.currentURL?.split('?')[0];\n\n  if (!currentPath) return false;\n\n  if (activeOnSubPaths ? !currentPath.startsWith(hrefPath) : hrefPath !== currentPath) return false;\n\n  const currentQueryParams = router.currentRoute?.queryParams;\n\n  if (!currentQueryParams) return false;\n\n  if (includeQueryParams === true) {\n    return Object.entries(currentQueryParams).every(([key, value]) => {\n      return hrefQueryParams.get(key) === value;\n    });\n  }\n\n  return includeQueryParams.every((key) => {\n    return hrefQueryParams.get(key) === currentQueryParams[key];\n  });\n}\n\ntype RouteInfo = ReturnType<RouterService['recognize']>;\n\nexport function getParams(currentRouteInfo: RouteInfo) {\n  let params: Record<string, string | unknown | undefined>[] = [];\n\n  while (currentRouteInfo?.parent) {\n    let currentParams = currentRouteInfo.params;\n\n    params = currentParams ? [currentParams, ...params] : params;\n    currentRouteInfo = currentRouteInfo.parent;\n  }\n\n  return params.map(Object.values).flat();\n}\n"],"names":["Link","Helper","g","prototype","service","i","void 0","compute","href","includeActiveQueryParams","activeOnSubPaths","assert","router","handleClick","event","target","HTMLAnchorElement","handle","isExternal","isActive","link","startsWith","location","origin","URL","includeQueryParams","info","recognize","dynamicSegments","getParams","routeName","name","replace","url","hrefQueryParams","URLSearchParams","searchParams","hrefPath","pathname","currentPath","currentURL","split","currentQueryParams","currentRoute","queryParams","Object","entries","every","key","value","get","currentRouteInfo","params","parent","currentParams","map","values","flat"],"mappings":";;;;;;AAuBe,MAAMA,IAAI,SAASC,MAAM,CAAY;AAAA,EAAA;IAAAC,CAAA,CAAA,IAAA,CAAAC,SAAA,EAAA,QAAA,EAAA,CACjDC,OAAO,CAAA,CAAA,CAAA;AAAA,GAAA;AAAA,EAAA,OAAA,IAAAC,CAAA,CAAA,IAAA,EAAA,QAAA,CAAA,EAAAC,KAAA,CAAA,EAAA;AAERC,EAAAA,OAAOA,CACL,CAACC,IAAI,CAAiB,EACtB;AACEC,IAAAA,wBAAwB,GAAG,KAAK;AAChCC,IAAAA,gBAAgB,GAAG,KAAA;AAC0D,GAAC,EAChF;AACAC,IAAAA,MAAM,CAAC,wBAAwB,EAAEH,IAAI,CAAC,CAAA;AAEtC,IAAA,MAAMI,MAAM,GAAG,IAAI,CAACA,MAAM,CAAA;IAC1B,MAAMC,WAAW,GAAIC,KAAiB,IAAK;MACzCH,MAAM,CAAC,OAAO,EAAEG,KAAK,CAACC,MAAM,YAAYC,iBAAiB,CAAC,CAAA;MAE1DC,MAAM,CAACL,MAAM,EAAEE,KAAK,CAACC,MAAM,EAAE,EAAE,EAAED,KAAK,CAAC,CAAA;KACxC,CAAA;IAED,OAAO;AACLI,MAAAA,UAAU,EAAEA,UAAU,CAACV,IAAI,CAAC;MAC5B,IAAIW,QAAQA,GAAG;QACb,OAAOA,QAAQ,CAACP,MAAM,EAAEJ,IAAI,EAAEC,wBAAwB,EAAEC,gBAAgB,CAAC,CAAA;OAC1E;AACDG,MAAAA,WAAAA;KACD,CAAA;AACH,GAAA;AACF,CAAA;AAEO,MAAMO,IAAI,GAAGpB,KAAI;AAEjB,SAASkB,UAAUA,CAACV,IAAY,EAAE;AACvC,EAAA,IAAI,CAACA,IAAI,EAAE,OAAO,KAAK,CAAA;EACvB,IAAIA,IAAI,CAACa,UAAU,CAAC,GAAG,CAAC,EAAE,OAAO,KAAK,CAAA;EACtC,IAAIb,IAAI,CAACa,UAAU,CAAC,GAAG,CAAC,EAAE,OAAO,KAAK,CAAA;EAEtC,OAAOC,QAAQ,CAACC,MAAM,KAAK,IAAIC,GAAG,CAAChB,IAAI,CAAC,CAACe,MAAM,CAAA;AACjD,CAAA;AAEO,SAASJ,QAAQA,CACtBP,MAAqB,EACrBJ,IAAY,EACZiB,kBAAuC,EACvCf,gBAA0B,EAC1B;EACA,IAAI,CAACe,kBAAkB,EAAE;AACvB;AACJ;AACA;AACI,IAAA,IAAIC,IAAI,GAAGd,MAAM,CAACe,SAAS,CAACnB,IAAI,CAAC,CAAA;AAEjC,IAAA,IAAIkB,IAAI,EAAE;AACR,MAAA,IAAIE,eAAe,GAAGC,SAAS,CAACH,IAAI,CAAC,CAAA;AACrC,MAAA,IAAII,SAAS,GAAGpB,gBAAgB,GAAGgB,IAAI,CAACK,IAAI,CAACC,OAAO,CAAC,UAAU,EAAE,EAAE,CAAC,GAAGN,IAAI,CAACK,IAAI,CAAA;MAEhF,OAAOnB,MAAM,CAACO,QAAQ,CAACW,SAAS,EAAE,GAAGF,eAAe,CAAC,CAAA;AACvD,KAAA;AAEA,IAAA,OAAO,KAAK,CAAA;AACd,GAAA;EAEA,IAAIK,GAAG,GAAG,IAAIT,GAAG,CAAChB,IAAI,EAAEc,QAAQ,CAACC,MAAM,CAAC,CAAA;EACxC,IAAIW,eAAe,GAAG,IAAIC,eAAe,CAACF,GAAG,CAACG,YAAY,CAAC,CAAA;AAC3D,EAAA,IAAIC,QAAQ,GAAGJ,GAAG,CAACK,QAAQ,CAAA;AAE3B,EAAA,MAAMC,WAAW,GAAG3B,MAAM,CAAC4B,UAAU,EAAEC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAA;AAEpD,EAAA,IAAI,CAACF,WAAW,EAAE,OAAO,KAAK,CAAA;AAE9B,EAAA,IAAI7B,gBAAgB,GAAG,CAAC6B,WAAW,CAAClB,UAAU,CAACgB,QAAQ,CAAC,GAAGA,QAAQ,KAAKE,WAAW,EAAE,OAAO,KAAK,CAAA;AAEjG,EAAA,MAAMG,kBAAkB,GAAG9B,MAAM,CAAC+B,YAAY,EAAEC,WAAW,CAAA;AAE3D,EAAA,IAAI,CAACF,kBAAkB,EAAE,OAAO,KAAK,CAAA;EAErC,IAAIjB,kBAAkB,KAAK,IAAI,EAAE;AAC/B,IAAA,OAAOoB,MAAM,CAACC,OAAO,CAACJ,kBAAkB,CAAC,CAACK,KAAK,CAAC,CAAC,CAACC,GAAG,EAAEC,KAAK,CAAC,KAAK;AAChE,MAAA,OAAOf,eAAe,CAACgB,GAAG,CAACF,GAAG,CAAC,KAAKC,KAAK,CAAA;AAC3C,KAAC,CAAC,CAAA;AACJ,GAAA;AAEA,EAAA,OAAOxB,kBAAkB,CAACsB,KAAK,CAAEC,GAAG,IAAK;IACvC,OAAOd,eAAe,CAACgB,GAAG,CAACF,GAAG,CAAC,KAAKN,kBAAkB,CAACM,GAAG,CAAC,CAAA;AAC7D,GAAC,CAAC,CAAA;AACJ,CAAA;AAIO,SAASnB,SAASA,CAACsB,gBAA2B,EAAE;EACrD,IAAIC,MAAsD,GAAG,EAAE,CAAA;EAE/D,OAAOD,gBAAgB,EAAEE,MAAM,EAAE;AAC/B,IAAA,IAAIC,aAAa,GAAGH,gBAAgB,CAACC,MAAM,CAAA;IAE3CA,MAAM,GAAGE,aAAa,GAAG,CAACA,aAAa,EAAE,GAAGF,MAAM,CAAC,GAAGA,MAAM,CAAA;IAC5DD,gBAAgB,GAAGA,gBAAgB,CAACE,MAAM,CAAA;AAC5C,GAAA;EAEA,OAAOD,MAAM,CAACG,GAAG,CAACV,MAAM,CAACW,MAAM,CAAC,CAACC,IAAI,EAAE,CAAA;AACzC;;;;"}